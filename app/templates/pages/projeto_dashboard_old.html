{% extends "app.html" %}
{% from "components/macros.html" import artefato_section %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/pages/projeto_dashboard.css') }}">
{% endblock %}

{% block content %}
<!-- Page Header -->
<!-- Page Header -->
<div class="page-header">
    <div class="page-header-left">
        <div class="page-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <line x1="10" y1="9" x2="8" y2="9"></line>
            </svg>
        </div>
        <div>
            <h1 class="page-title">Proj {{ projeto.id }} : {{ projeto.titulo }}</h1>
            <p class="page-subtitle">Gerencie os artefatos deste projeto seguindo o fluxo de contratação</p>
        </div>
    </div>
</div>

<!-- Fluxo Visual -->
<div class="fluxo-visual">
    {% if projeto.itens_pac|length == 0 %}
    <!-- Projeto sem PAC: começa com JE -->
    <div class="fluxo-item completo">
        <span class="fluxo-numero">1</span>
        <span class="fluxo-nome">JE</span>
    </div>
    <div class="fluxo-seta">→</div>
    {% endif %}
    <div class="fluxo-item {% if projeto.dfds|length > 0 %}completo{% else %}ativo{% endif %}">
        <span class="fluxo-numero">{% if projeto.itens_pac|length == 0 %}2{% else %}1{% endif %}</span>
        <span class="fluxo-nome">DFD</span>
    </div>
    <div class="fluxo-seta">→</div>
    <div
        class="fluxo-item {% if projeto.etps|length > 0 %}completo{% elif projeto.dfds|length > 0 %}ativo{% else %}bloqueado{% endif %}">
        <span class="fluxo-numero">{% if projeto.itens_pac|length == 0 %}3{% else %}2{% endif %}</span>
        <span class="fluxo-nome">ETP</span>
    </div>
    <div class="fluxo-seta">→</div>
    <div
        class="fluxo-item {% if projeto.riscos|length > 0 and projeto.pesquisas_precos|length > 0 %}completo{% elif projeto.dfds|length > 0 %}ativo{% else %}bloqueado{% endif %}">
        <span class="fluxo-numero">{% if projeto.itens_pac|length == 0 %}4{% else %}3{% endif %}</span>
        <span class="fluxo-nome">PP + PGR</span>
    </div>
    <div class="fluxo-seta">→</div>
    <div
        class="fluxo-item {% if projeto.trs|length > 0 %}completo{% elif artefatos_status.tr.liberado %}ativo{% else %}bloqueado{% endif %}">
        <span class="fluxo-numero">{% if projeto.itens_pac|length == 0 %}5{% else %}4{% endif %}</span>
        <span class="fluxo-nome">TR</span>
    </div>
    <div class="fluxo-seta">→</div>
    <div
        class="fluxo-item {% if projeto.editais|length > 0 %}completo{% elif artefatos_status.edital.liberado %}ativo{% else %}bloqueado{% endif %}">
        <span class="fluxo-numero">{% if projeto.itens_pac|length == 0 %}6{% else %}5{% endif %}</span>
        <span class="fluxo-nome">Edital</span>
    </div>
</div>

<!-- Artefatos List -->
<div class="artefatos-list">
    <!-- 0. JE (se projeto sem PAC) -->
    {% if projeto.itens_pac|length == 0 %}
    <div class="alert alert-info" style="margin-bottom: 1.5rem;">
        <svg style="width: 20px; height: 20px; vertical-align: text-bottom; margin-right: 8px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <strong>Projeto sem PAC:</strong> Crie uma <strong>Justificativa de Excepcionalidade (JE)</strong> para fundamentar a contratação de itens fora do catálogo, conforme Lei 14.133/2021.
    </div>
    
    {{ artefato_section(projeto.id, 'justificativa_excepcionalidade', 'JE - Justificativa de Excepcionalidade', [], True, []) }}
    {% endif %}

    <!-- 1. DFD -->
    {{ artefato_section(projeto.id, 'dfd', 'DFD - Documento de Formalização da Demanda', projeto.dfds, True, []) }}

    <!-- 1.5 PORTARIA DE DESIGNAÇÃO (apenas se DFD aprovado) -->
    {% set dfd_aprovado = projeto.dfds | selectattr("status", "in", ["aprovado", "publicado"]) | list %}
    {% if dfd_aprovado|length > 0 %}
    <div class="artefato-card portaria-card">
        <div class="artefato-header">
            <div class="artefato-icon artefato-icon-liberado artefato-icon-portaria_designacao">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <line x1="10" y1="9" x2="8" y2="9"></line>
                </svg>
            </div>
            <div class="artefato-info">
                <h3>Portaria de Designação</h3>
                <div class="artefato-meta">
                    <span class="badge badge-purple">DOCUMENTO VINCULADO</span>
                    <span class="text-muted">Automático a partir do DFD aprovado</span>
                </div>
            </div>
        </div>

        <div class="artefato-actions">
            <a href="/projetos/{{ projeto.id }}/portaria-designacao/print" class="btn btn-sm btn-primary" target="_blank">
                <i class="fas fa-file-pdf mr-1"></i> Visualizar PDF
            </a>
            <button class="btn btn-sm btn-info" onclick="publicarPortariaSEI({{ projeto.id }})">
                <i class="fas fa-share-alt mr-1"></i> Publicar no SEI
            </button>
        </div>
        
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee; font-size: 0.9rem; color: #666;">
            <strong>Informações:</strong> Documento que designa a Equipe de Planejamento da Contratação conforme Lei 14.133/2021, Art. 7º.
        </div>
    </div>
    {% endif %}

    <!-- 2. ETP -->
    {% set etp_liberado = projeto.dfds|length > 0 %}
    {{ artefato_section(projeto.id, 'etp', 'ETP - Estudo Técnico Preliminar', projeto.etps, etp_liberado, ['DFD']) }}

    <!-- 3. PP (Pesquisa de Preços) -->
    {% set pp_liberado = artefatos_status.pesquisa_precos.liberado if artefatos_status.pesquisa_precos else
    projeto.dfds|length > 0 %}
    {% set pp_faltando = artefatos_status.pesquisa_precos.faltando if artefatos_status.pesquisa_precos else [] %}
    {{ artefato_section(projeto.id, 'pesquisa_precos', 'PP - Pesquisa de Preços', projeto.pesquisas_precos, pp_liberado,
    pp_faltando) }}

    <!-- 4. PGR (Riscos) -->
    {% set pgr_liberado = projeto.dfds|length > 0 %}
    {{ artefato_section(projeto.id, 'riscos', 'PGR - Plano de Gerenciamento de Riscos', projeto.riscos, pgr_liberado,
    ['DFD']) }}

    <!-- 5. TR -->
    {% set tr_liberado = artefatos_status.tr.liberado %}
    {% set tr_faltando = artefatos_status.tr.faltando %}
    {{ artefato_section(projeto.id, 'tr', 'TR - Termo de Referência', projeto.trs, tr_liberado, tr_faltando) }}

    <!-- 6. Edital -->
    {% set edital_liberado = artefatos_status.edital.liberado %}
    {% set edital_faltando = artefatos_status.edital.faltando %}
    {{ artefato_section(projeto.id, 'edital', 'Edital de Licitação', projeto.editais, edital_liberado, edital_faltando)
    }}
</div>

<script>
    function criarNovaVersao(tipo, artefatoId) {
        if (!confirm('Deseja criar uma nova versao deste ' + tipo.toUpperCase() + '?')) return;

        fetch('/api/' + tipo + '/' + artefatoId + '/nova-versao', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
        })
            .then(function (response) {
                if (response.ok) { window.location.reload(); }
                else {
                    response.json().then(function (data) {
                        alert(data.detail || 'Erro ao criar versao');
                    }).catch(function () { alert('Erro ao processar resposta'); });
                }
            })
            .catch(function (error) { console.error('Erro:', error); alert('Erro ao conectar com o servidor'); });
    }

    // Generic Delete Function used by Macro
    function deletarArtefato(tipo, artefatoId) {
        if (!confirm('Tem certeza que deseja excluir este ' + tipo.toUpperCase() + '? Esta acao nao pode ser desfeita.')) return;
        fetch('/api/' + tipo + '/' + artefatoId, { method: 'DELETE', credentials: 'include' })
            .then(function (response) {
                if (response.ok) { window.location.reload(); }
                else { response.json().then(function (data) { alert(data.detail || 'Erro ao remover artefato'); }); }
            })
            .catch(function (error) { console.error('Erro:', error); alert('Erro ao conectar com o servidor'); });
    }

    // Generic PDF Function used by Macro
    function baixarPDF(tipo, artefatoId) {
        window.open('/api/' + tipo + '/' + artefatoId + '/pdf', '_blank');
    }

    // Portaria de Designação - Publicar no SEI
    function publicarPortariaSEI(projetoId) {
        if (!confirm('Deseja publicar a Portaria de Designação no SEI?')) return;
        
        fetch('/api/portaria-designacao/' + projetoId + '/publicar-sei', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
        })
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (data) {
                        alert('Portaria publicada no SEI com sucesso!\nProtocolo: ' + data.protocolo_sei.numero);
                        window.location.reload();
                    });
                } else {
                    response.json().then(function (data) {
                        alert(data.detail || 'Erro ao publicar Portaria');
                    }).catch(function () { alert('Erro ao processar resposta'); });
                }
            })
            .catch(function (error) { console.error('Erro:', error); alert('Erro ao conectar com o servidor'); });
    }


</script>
{% endblock %}