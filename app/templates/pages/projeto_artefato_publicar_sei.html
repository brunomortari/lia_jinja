{% extends "app.html" %}

{% block content %}
<div class="card" style="max-width: 900px; margin: 0 auto;">
    <div class="card-header">
        <h2 class="card-title">Publicar {{ config.sigla }} no SEI</h2>
        <p class="card-subtitle">Projeto: {{ projeto.titulo }} | Artefato: {{ config.titulo }}</p>
    </div>

    {% if success_message %}
    <div class="alert alert-success">
        <svg class="alert-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        <div>
            <strong>Sucesso!</strong><br>
            {{ success_message }}
        </div>
    </div>

    <div class="form-group">
        <label>Protocolo SEI Gerado</label>
        <div
            style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-md); border: 2px solid var(--border); font-family: monospace; font-size: 1.2rem; display: flex; align-items: center; justify-content: space-between;">
            <span>{{ sei_data.numero }}</span>
            <a href="{{ sei_data.link }}" target="_blank" class="btn btn-sm btn-ghost" title="Abrir no SEI">
                Link Externo
            </a>
        </div>
        <p class="text-sm text-gray-500 mt-2">
            Este artefato foi publicado e bloqueado para edições futuras.
        </p>
    </div>

    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
        <a href="/projetos/{{ projeto.id }}" class="btn btn-primary btn-block">Voltar para o Dashboard</a>
    </div>

    {% else %}

    <div class="alert alert-warning" style="margin-bottom: 2rem;">
        <svg class="alert-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
            <line x1="12" y1="9" x2="12" y2="13"></line>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
        <div>
            <strong>Atenção:</strong> Ao publicar esteartefato no SEI, ele será <u>bloqueado permanentemente</u> para
            edições.
            Verifique os dados abaixo antes de continuar.
        </div>
    </div>

    <!-- Review Data Section -->
    <div style="background: var(--bg-tertiary); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
        <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-primary);">Revisão dos Dados</h3>

        <div style="display: grid; gap: 1rem;">
            {% for key, conf in campos_config.items() %}
            <div class="review-item">
                <label
                    style="font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">
                    {{ conf.label }}
                </label>
                <div
                    style="background: white; padding: 0.75rem; border: 1px solid var(--border-light); border-radius: 4px; color: var(--text-primary); font-size: 0.95rem;">
                    {% set val = artefato|attr(key) %}
                    {% if val %}
                    {% if val is mapping or (val is sequence and val is not string) %}
                    <pre style="margin: 0; white-space: pre-wrap;">{{ val|tojson(indent=2) }}</pre>
                    {% else %}
                    {{ val }}
                    {% endif %}
                    {% else %}
                    <em>Não preenchido</em>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <form action="/projetos/{{ projeto.id }}/{{ tipo_artefato }}/{{ artefato.id }}/publicar-sei" method="POST">
        {% if csrf_token is defined %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        {% endif %}

        <div class="form-group">
            <label for="assunto">Assunto no SEI</label>
            <input type="text" id="assunto" name="assunto" required value="{{ config.titulo }} - {{ projeto.titulo }}"
                class="form-control"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;">
        </div>

        <div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem;">
            <a href="/projetos/{{ projeto.id }}" class="btn btn-secondary">Cancelar</a>
            <button type="submit" class="btn btn-primary" style="background-color: var(--color-primary);"
                onclick="return confirm('Confirma a publicação? O artefato será bloqueado.')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"
                    style="margin-right: 8px;">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                    <polyline points="22,6 12,13 2,6"></polyline>
                </svg>
                Publicar no SEI
            </button>
        </div>
    </form>
    {% endif %}
</div>
{% endblock %}