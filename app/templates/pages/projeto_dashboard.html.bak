{% extends "app.html" %}
{% from "components/macros.html" import artefato_section %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/pages/metro_flow.css') }}">
<link rel="stylesheet" href="{{ url_for('static', path='css/pages/projeto_dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header Section -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ projeto.nome }}</h1>
                <p class="text-gray-600">{{ projeto.descricao or 'Dashboard de artefatos e fluxo do projeto' }}</p>
            </div>
            <div class="flex gap-3">
                <a href="{{ url_for('projeto_dashboard', projeto_id=projeto.id) }}" 
                   class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">
                    ← Voltar ao Projeto
                </a>
                {% if active_branch %}
                <div class="px-4 py-2 bg-{{ {'principal': 'purple', 'adesao': 'green', 'dispensa': 'orange', 'direta': 'pink'}[active_branch] }}-100 text-{{ {'principal': 'purple', 'adesao': 'green', 'dispensa': 'orange', 'direta': 'pink'}[active_branch] }}-800 rounded-lg font-semibold">
                    Modalidade: {{ {'principal': 'Licitação Principal', 'adesao': 'Adesão a Ata', 'dispensa': 'Dispensa', 'direta': 'Contratação Direta'}[active_branch] }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ========================================
         METRO MAP - Visual Flow Diagram
         ======================================== -->
    <div class="metro-map-container bg-white rounded-xl shadow-lg p-8 mb-12" 
         data-active-branch="{{ active_branch or 'none' }}"
         data-decision-resolved="{{ 'true' if decision_resolved else 'false' }}">
        
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Fluxo do Projeto</h2>
            <p class="text-gray-600">Acompanhe o progresso através das fases do projeto</p>
        </div>

        <!-- SVG Metro Map -->
        <div class="metro-svg-wrapper" style="position: relative; min-height: 350px; overflow-x: auto;">
            <svg width="1200" height="350" viewBox="0 0 1200 350" xmlns="http://www.w3.org/2000/svg" class="metro-svg" style="max-width: 100%;">
                <defs>
                    <!-- Status gradients -->
                    <radialGradient id="statusDone" cx="50%" cy="50%" r="50%">
                        <stop offset="0%" style="stop-color:#10B981;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
                    </radialGradient>
                    
                    <radialGradient id="statusPending" cx="50%" cy="50%" r="50%">
                        <stop offset="0%" style="stop-color:#F59E0B;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#D97706;stop-opacity:1" />
                    </radialGradient>
                    
                    <radialGradient id="statusLocked" cx="50%" cy="50%" r="50%">
                        <stop offset="0%" style="stop-color:#9CA3AF;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#6B7280;stop-opacity:1" />
                    </radialGradient>
                </defs>

                <!-- Main Trunk Line: PAC/JEP → DFD → ETP → TR → PGR → Conclusão -->
                <g id="trunk-line">
                    {% if projeto_sem_pac %}
                        <line x1="60" y1="175" x2="140" y2="175" stroke="#DC2626" stroke-width="3" stroke-dasharray="5,5" />
                    {% else %}
                        <line x1="60" y1="175" x2="140" y2="175" stroke="#2B6CB0" stroke-width="3" />
                    {% endif %}
                    <line x1="210" y1="175" x2="290" y2="175" stroke="#2B6CB0" stroke-width="3" />
                    <line x1="360" y1="175" x2="440" y2="175" stroke="#2B6CB0" stroke-width="3" />
                    <line x1="510" y1="175" x2="590" y2="175" stroke="#2B6CB0" stroke-width="3" />
                    <line x1="660" y1="175" x2="740" y2="175" stroke="#2B6CB0" stroke-width="3" />
                    <line x1="810" y1="175" x2="890" y2="175" stroke="#2B6CB0" stroke-width="3" />
                </g>

                <!-- Pesquisa de Atas (dotted connection to ETP) -->
                <g id="pesquisa-atas">
                    <line x1="325" y1="195" x2="325" y2="260" stroke="#718096" stroke-width="2" stroke-dasharray="3,3" />
                    <circle cx="325" cy="280" r="8" fill="#E2E8F0" stroke="#718096" stroke-width="2" />
                    <text x="325" y="305" text-anchor="middle" class="text-xs fill-gray-600">Pesquisa de Atas</text>
                </g>

                <!-- Portaria de Designação (dotted connection to DFD) -->
                <g id="portaria-designacao">
                    <line x1="175" y1="195" x2="175" y2="260" stroke="#718096" stroke-width="2" stroke-dasharray="3,3" />
                    <circle cx="175" cy="280" r="8" fill="#E2E8F0" stroke="#718096" stroke-width="2" />
                    <text x="175" y="305" text-anchor="middle" class="text-xs fill-gray-600">Portaria de Designação</text>
                </g>

                <!-- TR Decision Point (bifurcation) -->
                <g id="tr-decision">
                    <circle cx="475" cy="175" r="12" fill="none" stroke="#2C5282" stroke-width="2" stroke-dasharray="4,2" />
                </g>

                <!-- Branch: Licitação (from TR upward) -->
                <g id="branch-licitacao">
                    <line x1="475" y1="165" x2="475" y2="80" stroke="#8B5CF6" stroke-width="2.5" />
                    <line x1="475" y1="80" x2="630" y2="80" stroke="#8B5CF6" stroke-width="2.5" />
                    <line x1="630" y1="80" x2="630" y2="165" stroke="#8B5CF6" stroke-width="2.5" />
                    
                    <circle cx="475" cy="80" r="10" fill="url(#{{ 'statusDone' if flow_state.get('edital') == 'completed' else 'statusLocked' }})" stroke="#8B5CF6" stroke-width="2" />
                    <text x="475" y="105" text-anchor="middle" class="text-xs fill-purple-700 font-medium">Edital</text>
                    
                    <circle cx="630" cy="80" r="10" fill="url(#{{ 'statusDone' if flow_state.get('arp') == 'completed' else 'statusLocked' }})" stroke="#8B5CF6" stroke-width="2" />
                    <text x="630" y="105" text-anchor="middle" class="text-xs fill-purple-700 font-medium">ARP</text>
                </g>

                <!-- Branch: Adesão a Ata (from TR downward-left) -->
                <g id="branch-adesao">
                    <line x1="465" y1="185" x2="380" y2="270" stroke="#10B981" stroke-width="2.5" />
                    <line x1="380" y1="270" x2="615" y2="270" stroke="#10B981" stroke-width="2.5" />
                    <line x1="615" y1="270" x2="615" y2="185" stroke="#10B981" stroke-width="2.5" />
                    
                    <circle cx="380" cy="270" r="10" fill="url(#{{ 'statusDone' if flow_state.get('adesao_ata') == 'completed' else 'statusLocked' }})" stroke="#10B981" stroke-width="2" />
                    <text x="380" y="295" text-anchor="middle" class="text-xs fill-green-700 font-medium">Adesão Ata</text>
                </g>

                <!-- Branch: Dispensa (from TR downward) -->
                <g id="branch-dispensa">
                    <line x1="475" y1="185" x2="475" y2="270" stroke="#F97316" stroke-width="2.5" />
                    <line x1="475" y1="270" x2="635" y2="270" stroke="#F97316" stroke-width="2.5" />
                    <line x1="635" y1="270" x2="635" y2="185" stroke="#F97316" stroke-width="2.5" />
                    
                    <circle cx="475" cy="270" r="10" fill="url(#{{ 'statusDone' if flow_state.get('dispensa') == 'completed' else 'statusLocked' }})" stroke="#F97316" stroke-width="2" />
                    <text x="475" y="295" text-anchor="middle" class="text-xs fill-orange-700 font-medium">Dispensa</text>
                </g>

                <!-- Branch: Contratação Direta (from TR to Conclusão) -->
                <g id="branch-contratacao-direta">
                    <line x1="485" y1="185" x2="570" y2="270" stroke="#EC4899" stroke-width="2.5" />
                    <line x1="570" y1="270" x2="890" y2="270" stroke="#EC4899" stroke-width="2.5" />
                    <line x1="890" y1="270" x2="890" y2="185" stroke="#EC4899" stroke-width="2.5" />
                    
                    <circle cx="570" cy="270" r="10" fill="url(#{{ 'statusDone' if flow_state.get('contratacao_direta') == 'completed' else 'statusLocked' }})" stroke="#EC4899" stroke-width="2" />
                    <text x="570" y="295" text-anchor="middle" class="text-xs fill-pink-700 font-medium">Contrat. Direta</text>
                </g>

                <!-- Main Trunk Stations -->
                {% if projeto_sem_pac %}
                    <g class="station" data-station="jep">
                        <circle cx="30" cy="175" r="13" fill="url(#{{ 'statusDone' if flow_state.get('jep') == 'completed' else ('statusPending' if flow_state.get('jep') == 'active' else 'statusLocked') }})" stroke="#DC2626" stroke-width="2.5" />
                        <text x="30" y="210" text-anchor="middle" class="text-sm font-semibold fill-red-700">JEP</text>
                        <text x="30" y="225" text-anchor="middle" class="text-xs fill-gray-600">Just. Excepc.</text>
                    </g>
                {% else %}
                    <g class="station" data-station="pac">
                        <circle cx="30" cy="175" r="13" fill="url(#{{ 'statusDone' if flow_state.get('pac') == 'completed' else ('statusPending' if flow_state.get('pac') == 'active' else 'statusLocked') }})" stroke="#2B6CB0" stroke-width="2.5" />
                        <text x="30" y="210" text-anchor="middle" class="text-sm font-semibold fill-blue-700">PAC</text>
                        <text x="30" y="225" text-anchor="middle" class="text-xs fill-gray-600">Plano Anual</text>
                    </g>
                {% endif %}

                <g class="station" data-station="dfd">
                    <circle cx="175" cy="175" r="13" fill="url(#{{ 'statusDone' if flow_state.get('dfd') == 'completed' else ('statusPending' if flow_state.get('dfd') == 'active' else 'statusLocked') }})" stroke="#2B6CB0" stroke-width="2.5" />
                    <text x="175" y="210" text-anchor="middle" class="text-sm font-semibold fill-blue-700">DFD</text>
                    <text x="175" y="225" text-anchor="middle" class="text-xs fill-gray-600">Doc. Formaliz.</text>
                </g>

                <g class="station" data-station="etp">
                    <circle cx="325" cy="175" r="13" fill="url(#{{ 'statusDone' if flow_state.get('etp') == 'completed' else ('statusPending' if flow_state.get('etp') == 'active' else 'statusLocked') }})" stroke="#2B6CB0" stroke-width="2.5" />
                    <text x="325" y="210" text-anchor="middle" class="text-sm font-semibold fill-blue-700">ETP</text>
                    <text x="325" y="225" text-anchor="middle" class="text-xs fill-gray-600">Estudo Técnico</text>
                </g>

                <g class="station" data-station="tr">
                    <circle cx="475" cy="175" r="13" fill="url(#{{ 'statusDone' if flow_state.get('tr') == 'completed' else ('statusPending' if flow_state.get('tr') == 'active' else 'statusLocked') }})" stroke="#2B6CB0" stroke-width="2.5" />
                    <text x="475" y="210" text-anchor="middle" class="text-sm font-semibold fill-blue-700">TR</text>
                    <text x="475" y="225" text-anchor="middle" class="text-xs fill-gray-600">Termo Refer.</text>
                </g>

                <g class="station" data-station="pgr">
                    <circle cx="625" cy="175" r="13" fill="url(#{{ 'statusDone' if flow_state.get('pgr') == 'completed' else ('statusPending' if flow_state.get('pgr') == 'active' else 'statusLocked') }})" stroke="#2B6CB0" stroke-width="2.5" />
                    <text x="625" y="210" text-anchor="middle" class="text-sm font-semibold fill-blue-700">PGR</text>
                    <text x="625" y="225" text-anchor="middle" class="text-xs fill-gray-600">Plan. Gestão</text>
                </g>

                <g class="station" data-station="conclusao">
                    <circle cx="920" cy="175" r="13" fill="url(#{{ 'statusDone' if flow_state.get('conclusao') == 'completed' else ('statusPending' if flow_state.get('conclusao') == 'active' else 'statusLocked') }})" stroke="#10B981" stroke-width="2.5" />
                    <text x="920" y="210" text-anchor="middle" class="text-sm font-semibold fill-green-700">Conclusão</text>
                    <text x="920" y="225" text-anchor="middle" class="text-xs fill-gray-600">Finalizado</text>
                </g>
            </svg>

            <!-- Compact Legend -->
            <div class="metro-legend mt-4 flex flex-wrap gap-3 justify-center items-center text-xs">
                <div class="flex items-center gap-1.5">
                    <div class="w-8 h-1 bg-blue-700 rounded"></div>
                    <span class="text-gray-600">Tronco</span>
                </div>
                <div class="flex items-center gap-1.5">
                    <div class="w-8 h-1 bg-purple-600 rounded"></div>
                    <span class="text-gray-600">Licitação</span>
                </div>
                <div class="flex items-center gap-1.5">
                    <div class="w-8 h-1 bg-green-600 rounded"></div>
                    <span class="text-gray-600">Adesão</span>
                </div>
                <div class="flex items-center gap-1.5">
                    <div class="w-8 h-1 bg-orange-600 rounded"></div>
                    <span class="text-gray-600">Dispensa</span>
                </div>
                <div class="flex items-center gap-1.5">
                    <div class="w-8 h-1 bg-pink-600 rounded"></div>
                    <span class="text-gray-600">Contrat. Direta</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         ARTIFACT CARDS - Grouped by Phase
         ======================================== -->
    <div class="artifacts-container">
        
        <!-- Phase: Planejamento Inicial -->
        <div class="phase-divider" data-phase="planejamento">
            <div class="flex items-center gap-3 mb-6">
                <div class="h-px flex-1 bg-gradient-to-r from-transparent via-blue-300 to-blue-500"></div>
                <h3 class="text-xl font-bold text-blue-800 px-4 py-2 bg-blue-50 rounded-lg shadow-sm">
                    Fase: Planejamento Inicial
                </h3>
                <div class="h-px flex-1 bg-gradient-to-r from-blue-500 via-blue-300 to-transparent"></div>
            </div>
        </div>

        <!-- JEP Card (only when project has no PAC) -->
        {% if projeto_sem_pac %}
        <div class="artefato-card artefato-card-alerta" style="border-left: 4px solid #E53E3E; background: linear-gradient(135deg, #FFF5F5 0%, #FED7D7 100%); margin-bottom: 1.5rem;">
            <div class="artefato-header">
                <div class="artefato-icon" style="background-color: #E53E3E !important;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="24" height="24">
                        <polygon points="12 2 22 22 2 22"></polygon>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                </div>
                <div class="artefato-info">
                    <h3 style="color: #C53030;">Justificativa de Contratação não Planejada</h3>
                    <div class="artefato-meta">
                        <span class="badge" style="background: #FED7D7; color: #9B2C2C;">OBRIGATÓRIO - Sem PAC</span>
                        <span class="text-muted">
                            {{ projeto.justificativas_excepcionalidade|length if projeto.justificativas_excepcionalidade else 0 }} versão(ões)
                        </span>
                    </div>
                    <p style="font-size: 0.8rem; color: #9B2C2C; margin-top: 6px;">
                        ⚠️ Contratações fora do PAC são monitoradas pelos tribunais de contas. 
                        Certifique-se de que a motivação não configure falta de planejamento.
                    </p>
                </div>
            </div>
            <div class="artefato-actions">
                {% set jep_list = projeto.justificativas_excepcionalidade %}
                {% set jep_locked = jep_list and jep_list[0].protocolo_sei %}
                {% if not jep_locked %}
                <a href="/projetos/{{ projeto.id }}/jep" class="btn btn-sm" style="background: #E53E3E; color: white;">
                    {% if jep_list %}
                    <i class="fas fa-edit mr-1"></i> Editar Justificativa
                    {% else %}
                    <i class="fas fa-plus mr-1"></i> Criar Justificativa
                    {% endif %}
                </a>
                {% else %}
                <span class="text-muted" style="font-size: 0.85rem;">Publicado no SEI</span>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- DFD Card -->
        {{ artefato_section(
            projeto_id=projeto.id,
            tipo='dfd',
            titulo='Documento de Formalização da Demanda',
            artefatos=projeto.dfds,
            liberado=artefatos_status.get('dfd', {}).get('liberado', False),
            faltando=artefatos_status.get('dfd', {}).get('faltando', [])
        ) }}

        <!-- ETP Card -->
        {{ artefato_section(
            projeto_id=projeto.id,
            tipo='etp',
            titulo='Estudo Técnico Preliminar',
            artefatos=projeto.etps,
            liberado=artefatos_status.get('etp', {}).get('liberado', False),
            faltando=artefatos_status.get('etp', {}).get('faltando', [])
        ) }}

        <!-- Portaria Designação Card -->
        {% if artefatos_config.get('portaria') %}
        {{ artefato_section(
            projeto_id=projeto.id,
            tipo='portaria',
            titulo='Portaria de Designação',
            artefatos=projeto.portarias_designacao,
            liberado=artefatos_status.get('portaria', {}).get('liberado', False),
            faltando=artefatos_status.get('portaria', {}).get('faltando', [])
        ) }}
        {% endif %}

        <!-- Phase: Pesquisa e Análise (Principal) -->
        {% if active_branch == 'principal' %}
        <div class="phase-divider" data-phase="pesquisa">
            <div class="flex items-center gap-3 my-6">
                <div class="h-px flex-1 bg-gradient-to-r from-transparent via-purple-300 to-purple-500"></div>
                <h3 class="text-xl font-bold text-purple-800 px-4 py-2 bg-purple-50 rounded-lg shadow-sm">
                    Fase: Pesquisa e Análise de Mercado
                </h3>
                <div class="h-px flex-1 bg-gradient-to-r from-purple-500 via-purple-300 to-transparent"></div>
            </div>
        </div>

        <!-- PP Card -->
        {{ artefato_section(
            projeto_id=projeto.id,
            tipo='pp',
            titulo='Pesquisa de Preços',
            artefatos=projeto.pesquisas_precos,
            liberado=artefatos_status.get('pp', {}).get('liberado', False),
            faltando=artefatos_status.get('pp', {}).get('faltando', [])
        ) }}

        <!-- PGR Card -->
        {{ artefato_section(
            projeto_id=projeto.id,
            tipo='pgr',
            titulo='Plano de Gestão de Riscos',
            artefatos=projeto.riscos,
            liberado=artefatos_status.get('pgr', {}).get('liberado', False),
            faltando=artefatos_status.get('pgr', {}).get('faltando', [])
        ) }}

        <!-- Phase: Documentação Técnica (Principal) -->
        <div class="phase-divider" data-phase="documentacao">
            <div class="flex items-center gap-3 my-6">
                <div class="h-px flex-1 bg-gradient-to-r from-transparent via-purple-300 to-purple-500"></div>
                <h3 class="text-xl font-bold text-purple-800 px-4 py-2 bg-purple-50 rounded-lg shadow-sm">
                    Fase: Documentação Técnica
                </h3>
                <div class="h-px flex-1 bg-gradient-to-r from-purple-500 via-purple-300 to-transparent"></div>
            </div>
        </div>

        <!-- TR Card -->
        {{ artefato_section(
            projeto_id=projeto.id,
            tipo='tr',
            titulo='Termo de Referência',
            artefatos=projeto.trs,
            liberado=artefatos_status.get('tr', {}).get('liberado', False),
            faltando=artefatos_status.get('tr', {}).get('faltando', [])
        ) }}

        <!-- CHK Card -->
        {{ artefato_section(
            projeto_id=projeto.id,
            tipo='chk',
            titulo='Checklist de Adequação',
            artefatos=projeto.checklists_conformidade,
            liberado=artefatos_status.get('chk', {}).get('liberado', False),
            faltando=artefatos_status.get('chk', {}).get('faltando', [])
        ) }}

        <!-- Phase: Formalização (Principal) -->
        <div class="phase-divider" data-phase="formalizacao">
            <div class="flex items-center gap-3 my-6">
                <div class="h-px flex-1 bg-gradient-to-r from-transparent via-purple-300 to-purple-500"></div>
                <h3 class="text-xl font-bold text-purple-800 px-4 py-2 bg-purple-50 rounded-lg shadow-sm">
                    Fase: Formalização da Licitação
                </h3>
                <div class="h-px flex-1 bg-gradient-to-r from-purple-500 via-purple-300 to-transparent"></div>
            </div>
        </div>

        <!-- Edital Card -->
        {{ artefato_section(
            projeto_id=projeto.id,
            tipo='edital',
            titulo='Edital/Aviso de Contratação',
            artefatos=projeto.editais,
            liberado=artefatos_status.get('edital', {}).get('liberado', False),
            faltando=artefatos_status.get('edital', {}).get('faltando', [])
        ) }}

        <!-- MC Card -->
        {{ artefato_section(
            projeto_id=projeto.id,
            tipo='mc',
            titulo='Minuta de Contrato',
            artefatos=projeto.minutas_contrato,
            liberado=artefatos_status.get('mc', {}).get('liberado', False),
            faltando=artefatos_status.get('mc', {}).get('faltando', [])
        ) }}
        {% endif %}

        <!-- Adesão a Ata Branch -->
        {% if active_branch == 'adesao' %}
        <div class="phase-divider" data-phase="adesao-docs">
            <div class="flex items-center gap-3 my-6">
                <div class="h-px flex-1 bg-gradient-to-r from-transparent via-green-300 to-green-500"></div>
                <h3 class="text-xl font-bold text-green-800 px-4 py-2 bg-green-50 rounded-lg shadow-sm">
                    Fase: Documentação de Adesão a Ata
                </h3>
                <div class="h-px flex-1 bg-gradient-to-r from-green-500 via-green-300 to-transparent"></div>
            </div>
        </div>

        <!-- RDVE Card -->
        {{ artefato_section(
            projeto_id=projeto.id,
            tipo='rdve',
            titulo='Requerimento de DVE',
            artefatos=projeto.relatorios_vantagem_economica,
            liberado=artefatos_status.get('rdve', {}).get('liberado', False),
            faltando=artefatos_status.get('rdve', {}).get('faltando', [])
        ) }}

        <!-- JVA Card -->
        {{ artefato_section(
            projeto_id=projeto.id,
            tipo='jva',
            titulo='Justificativa de Adesão',
            artefatos=projeto.justificativas_vantagem_adesao,
            liberado=artefatos_status.get('jva', {}).get('liberado', False),
            faltando=artefatos_status.get('jva', {}).get('faltando', [])
        ) }}

        <!-- TAFO Card -->
        {{ artefato_section(
            projeto_id=projeto.id,
            tipo='tafo',
            titulo='Termo de Adesão Formalizado',
            artefatos=projeto.termos_aceite_fornecedor,
            liberado=artefatos_status.get('tafo', {}).get('liberado', False),
            faltando=artefatos_status.get('tafo', {}).get('faltando', [])
        ) }}
        {% endif %}

        <!-- Dispensa Branch -->
        {% if active_branch == 'dispensa' %}
        <div class="phase-divider" data-phase="dispensa-docs">
            <div class="flex items-center gap-3 my-6">
                <div class="h-px flex-1 bg-gradient-to-r from-transparent via-orange-300 to-orange-500"></div>
                <h3 class="text-xl font-bold text-orange-800 px-4 py-2 bg-orange-50 rounded-lg shadow-sm">
                    Fase: Documentação de Dispensa
                </h3>
                <div class="h-px flex-1 bg-gradient-to-r from-orange-500 via-orange-300 to-transparent"></div>
            </div>
        </div>

        <!-- TRS Card -->
        {{ artefato_section(
            projeto_id=projeto.id,
            tipo='trs',
            titulo='Termo de Referência Simplificado',
            artefatos=projeto.trs_simplificados,
            liberado=artefatos_status.get('trs', {}).get('liberado', False),
            faltando=artefatos_status.get('trs', {}).get('faltando', [])
        ) }}

        <!-- ADE Card -->
        {{ artefato_section(
            projeto_id=projeto.id,
            tipo='ade',
            titulo='Autorização de Dispensa',
            artefatos=projeto.avisos_dispensa_eletronica,
            liberado=artefatos_status.get('ade', {}).get('liberado', False),
            faltando=artefatos_status.get('ade', {}).get('faltando', [])
        ) }}

        <!-- JPEF Card -->
        {{ artefato_section(
            projeto_id=projeto.id,
            tipo='jpef',
            titulo='Justificativa de Preço',
            artefatos=projeto.justificativas_preco_escolha,
            liberado=artefatos_status.get('jpef', {}).get('liberado', False),
            faltando=artefatos_status.get('jpef', {}).get('faltando', [])
        ) }}

        <!-- CE Card -->
        {{ artefato_section(
            projeto_id=projeto.id,
            tipo='ce',
            titulo='Contrato/Empenho',
            artefatos=projeto.certidoes_enquadramento,
            liberado=artefatos_status.get('ce', {}).get('liberado', False),
            faltando=artefatos_status.get('ce', {}).get('faltando', [])
        ) }}
        {% endif %}

        <!-- Direta Branch -->
        {% if active_branch == 'direta' %}
        <div class="phase-divider" data-phase="direta-docs">
            <div class="flex items-center gap-3 my-6">
                <div class="h-px flex-1 bg-gradient-to-r from-transparent via-pink-300 to-pink-500"></div>
                <h3 class="text-xl font-bold text-pink-800 px-4 py-2 bg-pink-50 rounded-lg shadow-sm">
                    Fase: Contratação Direta
                </h3>
                <div class="h-px flex-1 bg-gradient-to-r from-pink-500 via-pink-300 to-transparent"></div>
            </div>
        </div>

        <!-- APD Card -->
        {{ artefato_section(
            projeto_id=projeto.id,
            tipo='apd',
            titulo='Autorização Prévia Direta',
            artefatos=projeto.avisos_publicidade_direta,
            liberado=artefatos_status.get('apd', {}).get('liberado', False),
            faltando=artefatos_status.get('apd', {}).get('faltando', [])
        ) }}

        <!-- JFE Card -->
        {{ artefato_section(
            projeto_id=projeto.id,
            tipo='jfe',
            titulo='Justificativa de Contratação Direta',
            artefatos=projeto.justificativas_fornecedor_escolhido,
            liberado=artefatos_status.get('jfe', {}).get('liberado', False),
            faltando=artefatos_status.get('jfe', {}).get('faltando', [])
        ) }}
        {% endif %}

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global project data for JS
    const projetoId = {{ projeto.id }};
    const activeBranch = "{{ active_branch or 'none' }}";
    const decisionResolved = {{ 'true' if decision_resolved else 'false' }};
</script>
<script src="{{ url_for('static', path='js/metro_flow.js') }}"></script>
{% endblock %}
