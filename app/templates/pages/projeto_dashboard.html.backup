{% extends "app.html" %}
{% from "components/macros.html" import artefato_section %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/pages/projeto_dashboard.css') }}">
<style>
/* Tabs Styling */
.fluxos-tabs {
    margin-bottom: 2rem;
}

.tabs-nav {
    display: flex;
    gap: 0.5rem;
    border-bottom: 2px solid #e2e8f0;
    margin-bottom: 1.5rem;
}

.tab-btn {
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 500;
    color: #64748b;
    transition: all 0.2s;
}

.tab-btn:hover {
    color: #334155;
    background: #f8fafc;
}

.tab-btn.active {
    color: #3182ce;
    border-bottom-color: #3182ce;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.flow-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-bottom: 1rem;
}

.flow-badge.principal { background: #dbeafe; color: #1e40af; }
.flow-badge.adesao { background: #d1fae5; color: #065f46; }
.flow-badge.dispensa { background: #fed7aa; color: #92400e; }
.flow-badge.direta { background: #ddd6fe; color: #5b21b6; }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="page-header-left">
        <div class="page-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <line x1="10" y1="9" x2="8" y2="9"></line>
            </svg>
        </div>
        <div>
            <h1 class="page-title">{{ projeto.titulo }}</h1>
            <p class="page-subtitle">Gerencie os artefatos seguindo os fluxos de contrata√ß√£o da Lei 14.133/2021</p>
        </div>
    </div>
</div>

<!-- Tabs de Fluxos -->
<div class="fluxos-tabs">
    <div class="tabs-nav">
        <button class="tab-btn active" onclick="switchTab('principal')" data-tab="principal">
            üèõÔ∏è Fluxo Principal
        </button>
        <button class="tab-btn" onclick="switchTab('adesao')" data-tab="adesao">
            ü§ù Ades√£o a Ata
        </button>
        <button class="tab-btn" onclick="switchTab('dispensa')" data-tab="dispensa">
            ‚ö° Dispensa Valor Baixo
        </button>
        <button class="tab-btn" onclick="switchTab('direta')" data-tab="direta">
            üìå Contrata√ß√£o Direta
        </button>
    </div>

    <!-- TAB 1: FLUXO PRINCIPAL -->
    <div class="tab-content active" id="tab-principal">
        <span class="flow-badge principal">LICITA√á√ÉO NORMAL - Lei 14.133/2021</span>
        
        <div class="artefatos-list">
            <!-- JE (se projeto sem PAC) -->
            {% if projeto.itens_pac|length == 0 %}
            <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                <svg style="width: 20px; height: 20px; vertical-align: text-bottom; margin-right: 8px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                <strong>Projeto sem PAC:</strong> Crie uma <strong>Justificativa de Excepcionalidade (JE)</strong>.
            </div>
            {{ artefato_section(projeto.id, 'justificativa_excepcionalidade', 'JE - Justificativa de Excepcionalidade', [], True, []) }}
            {% endif %}

            <!-- 1. DFD -->
            {{ artefato_section(projeto.id, 'dfd', 'DFD - Documento de Formaliza√ß√£o da Demanda', projeto.dfds, True, []) }}

            <!-- 1.5 Portaria Designa√ß√£o -->
            {% set dfd_aprovado = projeto.dfds | selectattr("status", "in", ["aprovado", "publicado"]) | list %}
            {% if dfd_aprovado|length > 0 %}
            <div class="artefato-card portaria-card">
                <div class="artefato-header">
                    <div class="artefato-icon artefato-icon-liberado artefato-icon-portaria_designacao">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <line x1="10" y1="9" x2="8" y2="9"></line>
                        </svg>
                    </div>
                    <div class="artefato-info">
                        <h3>Portaria de Designa√ß√£o</h3>
                        <div class="artefato-meta">
                            <span class="badge badge-purple">DOCUMENTO VINCULADO</span>
                            <span class="text-muted">Autom√°tico a partir do DFD aprovado</span>
                        </div>
                    </div>
                </div>
                <div class="artefato-actions">
                    <a href="/projetos/{{ projeto.id }}/portaria-designacao/print" class="btn btn-sm btn-primary" target="_blank">
                        <i class="fas fa-file-pdf mr-1"></i> Visualizar PDF
                    </a>
                    <button class="btn btn-sm btn-info" onclick="publicarPortariaSEI({{ projeto.id }})">
                        <i class="fas fa-share-alt mr-1"></i> Publicar no SEI
                    </button>
                </div>
            </div>
            {% endif %}

            <!-- 2. ETP -->
            {% set etp_liberado = projeto.dfds|length > 0 %}
            {{ artefato_section(projeto.id, 'etp', 'ETP - Estudo T√©cnico Preliminar', projeto.etps, etp_liberado, ['DFD']) }}

            <!-- 3. PP -->
            {% set pp_liberado = artefatos_status.pesquisa_precos.liberado if artefatos_status.pesquisa_precos else projeto.dfds|length > 0 %}
            {% set pp_faltando = artefatos_status.pesquisa_precos.faltando if artefatos_status.pesquisa_precos else [] %}
            {{ artefato_section(projeto.id, 'pesquisa_precos', 'PP - Pesquisa de Pre√ßos', projeto.pesquisas_precos, pp_liberado, pp_faltando) }}

            <!-- 4. PGR -->
            {% set pgr_liberado = projeto.dfds|length > 0 %}
            {{ artefato_section(projeto.id, 'riscos', 'PGR - Plano de Gerenciamento de Riscos', projeto.riscos, pgr_liberado, ['DFD']) }}

            <!-- 5. TR -->
            {% set tr_liberado = artefatos_status.tr.liberado %}
            {% set tr_faltando = artefatos_status.tr.faltando %}
            {{ artefato_section(projeto.id, 'tr', 'TR - Termo de Refer√™ncia', projeto.trs, tr_liberado, tr_faltando) }}

            <!-- 6. CHK -->
            {% set chk_liberado = artefatos_status.checklist_conformidade.liberado if artefatos_status.checklist_conformidade else False %}
            {% set chk_faltando = artefatos_status.checklist_conformidade.faltando if artefatos_status.checklist_conformidade else ['TR'] %}
            {{ artefato_section(projeto.id, 'checklist_conformidade', 'CHK - Checklist de Conformidade', projeto.checklists_conformidade, chk_liberado, chk_faltando) }}

            <!-- 7. Edital -->
            {% set edital_liberado = artefatos_status.edital.liberado %}
            {% set edital_faltando = artefatos_status.edital.faltando %}
            {{ artefato_section(projeto.id, 'edital', 'ED - Edital de Licita√ß√£o', projeto.editais, edital_liberado, edital_faltando) }}

            <!-- 8. MC -->
            {% set mc_liberado = artefatos_status.minuta_contrato.liberado if artefatos_status.minuta_contrato else False %}
            {% set mc_faltando = artefatos_status.minuta_contrato.faltando if artefatos_status.minuta_contrato else ['Edital'] %}
            {{ artefato_section(projeto.id, 'minuta_contrato', 'MC - Minuta de Contrato', projeto.minutas_contrato, mc_liberado, mc_faltando) }}
        </div>
    </div>

    <!-- TAB 2: ADES√ÉO A ATA -->
    <div class="tab-content" id="tab-adesao">
        <span class="flow-badge adesao">ADES√ÉO A ATA DE REGISTRO DE PRE√áOS - Art. 37, Lei 14.133/2021</span>
        
        <div class="artefatos-list">
            <!-- Base: DFD + ETP -->
            {{ artefato_section(projeto.id, 'dfd', 'DFD - Documento de Formaliza√ß√£o da Demanda', projeto.dfds, True, []) }}
            
            {% set etp_liberado = projeto.dfds|length > 0 %}
            {{ artefato_section(projeto.id, 'etp', 'ETP - Estudo T√©cnico Preliminar', projeto.etps, etp_liberado, ['DFD']) }}

            <!-- RDVE -->
            {% set rdve_liberado = artefatos_status.rdve.liberado if artefatos_status.rdve else False %}
            {% set rdve_faltando = artefatos_status.rdve.faltando if artefatos_status.rdve else ['ETP'] %}
            {{ artefato_section(projeto.id, 'rdve', 'RDVE - Relat√≥rio de Vantagem Econ√¥mica', projeto.relatorios_vantagem_economica, rdve_liberado, rdve_faltando) }}

            <!-- JVA -->
            {% set jva_liberado = artefatos_status.jva.liberado if artefatos_status.jva else False %}
            {% set jva_faltando = artefatos_status.jva.faltando if artefatos_status.jva else ['RDVE'] %}
            {{ artefato_section(projeto.id, 'jva', 'JVA - Justificativa de Vantagem da Ades√£o', projeto.justificativas_vantagem_adesao, jva_liberado, jva_faltando) }}

            <!-- TAFO -->
            {% set tafo_liberado = artefatos_status.tafo.liberado if artefatos_status.tafo else False %}
            {% set tafo_faltando = artefatos_status.tafo.faltando if artefatos_status.tafo else ['JVA'] %}
            {{ artefato_section(projeto.id, 'tafo', 'TAFO - Termo de Aceite do Fornecedor', projeto.termos_aceite_fornecedor, tafo_liberado, tafo_faltando) }}
        </div>
    </div>

    <!-- TAB 3: DISPENSA POR VALOR BAIXO -->
    <div class="tab-content" id="tab-dispensa">
        <span class="flow-badge dispensa">DISPENSA POR VALOR BAIXO - Art. 75, Lei 14.133/2021</span>
        
        <div class="artefatos-list">
            <!-- Base: DFD + ETP -->
            {{ artefato_section(projeto.id, 'dfd', 'DFD - Documento de Formaliza√ß√£o da Demanda', projeto.dfds, True, []) }}
            
            {% set etp_liberado = projeto.dfds|length > 0 %}
            {{ artefato_section(projeto.id, 'etp', 'ETP - Estudo T√©cnico Preliminar', projeto.etps, etp_liberado, ['DFD']) }}

            <!-- TRS -->
            {% set trs_liberado = artefatos_status.trs.liberado if artefatos_status.trs else False %}
            {% set trs_faltando = artefatos_status.trs.faltando if artefatos_status.trs else ['ETP'] %}
            {{ artefato_section(projeto.id, 'trs', 'TRS - Termo de Refer√™ncia Simplificado', projeto.trs_simplificados, trs_liberado, trs_faltando) }}

            <!-- ADE -->
            {% set ade_liberado = artefatos_status.ade.liberado if artefatos_status.ade else False %}
            {% set ade_faltando = artefatos_status.ade.faltando if artefatos_status.ade else ['TRS'] %}
            {{ artefato_section(projeto.id, 'ade', 'ADE - Aviso de Dispensa Eletr√¥nica', projeto.avisos_dispensa_eletronica, ade_liberado, ade_faltando) }}

            <!-- JPEF -->
            {% set jpef_liberado = artefatos_status.jpef.liberado if artefatos_status.jpef else False %}
            {% set jpef_faltando = artefatos_status.jpef.faltando if artefatos_status.jpef else ['ADE'] %}
            {{ artefato_section(projeto.id, 'jpef', 'JPEF - Justificativa de Pre√ßo/Escolha Fornecedor', projeto.justificativas_preco_escolha, jpef_liberado, jpef_faltando) }}

            <!-- CE -->
            {% set ce_liberado = artefatos_status.ce.liberado if artefatos_status.ce else False %}
            {% set ce_faltando = artefatos_status.ce.faltando if artefatos_status.ce else ['JPEF'] %}
            {{ artefato_section(projeto.id, 'ce', 'CE - Certid√£o de Enquadramento', projeto.certidoes_enquadramento, ce_liberado, ce_faltando) }}
        </div>
    </div>

    <!-- TAB 4: CONTRATA√á√ÉO DIRETA -->
    <div class="tab-content" id="tab-direta">
        <span class="flow-badge direta">CONTRATA√á√ÉO DIRETA - Dispensa/Inexigibilidade, Lei 14.133/2021</span>
        
        <div class="artefatos-list">
            <!-- Base: DFD + ETP + TR -->
            {{ artefato_section(projeto.id, 'dfd', 'DFD - Documento de Formaliza√ß√£o da Demanda', projeto.dfds, True, []) }}
            
            {% set etp_liberado = projeto.dfds|length > 0 %}
            {{ artefato_section(projeto.id, 'etp', 'ETP - Estudo T√©cnico Preliminar', projeto.etps, etp_liberado, ['DFD']) }}

            {% set tr_liberado = artefatos_status.tr.liberado %}
            {% set tr_faltando = artefatos_status.tr.faltando %}
            {{ artefato_section(projeto.id, 'tr', 'TR - Termo de Refer√™ncia', projeto.trs, tr_liberado, tr_faltando) }}

            <!-- APD -->
            {% set apd_liberado = artefatos_status.aviso_publicidade_direta.liberado if artefatos_status.aviso_publicidade_direta else False %}
            {% set apd_faltando = artefatos_status.aviso_publicidade_direta.faltando if artefatos_status.aviso_publicidade_direta else ['TR'] %}
            {{ artefato_section(projeto.id, 'aviso_publicidade_direta', 'APD - Aviso de Dispensa de Licita√ß√£o', projeto.avisos_publicidade_direta, apd_liberado, apd_faltando) }}

            <!-- JFE -->
            {% set jfe_liberado = artefatos_status.justificativa_fornecedor_escolhido.liberado if artefatos_status.justificativa_fornecedor_escolhido else False %}
            {% set jfe_faltando = artefatos_status.justificativa_fornecedor_escolhido.faltando if artefatos_status.justificativa_fornecedor_escolhido else ['APD'] %}
            {{ artefato_section(projeto.id, 'justificativa_fornecedor_escolhido', 'JFE - Justificativa do Fornecedor Escolhido', projeto.justificativas_fornecedor_escolhido, jfe_liberado, jfe_faltando) }}
        </div>
    </div>
</div>

<script>
function switchTab(tabName) {
    // Desativar todas as tabs
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    // Ativar tab selecionada
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`tab-${tabName}`).classList.add('active');
}

function criarNovaVersao(tipo, artefatoId) {
    if (!confirm('Deseja criar uma nova vers√£o deste ' + tipo.toUpperCase() + '?')) return;

    fetch('/api/' + tipo + '/' + artefatoId + '/nova-versao', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
    })
        .then(function (response) {
            if (response.ok) { window.location.reload(); }
            else {
                response.json().then(function (data) {
                    alert(data.detail || 'Erro ao criar vers√£o');
                }).catch(function () { alert('Erro ao processar resposta'); });
            }
        })
        .catch(function (error) { console.error('Erro:', error); alert('Erro ao conectar com o servidor'); });
}

function deletarArtefato(tipo, artefatoId) {
    if (!confirm('Tem certeza que deseja excluir este ' + tipo.toUpperCase() + '? Esta a√ß√£o n√£o pode ser desfeita.')) return;
    fetch('/api/' + tipo + '/' + artefatoId, { method: 'DELETE', credentials: 'include' })
        .then(function (response) {
            if (response.ok) { window.location.reload(); }
            else { response.json().then(function (data) { alert(data.detail || 'Erro ao remover artefato'); }); }
        })
        .catch(function (error) { console.error('Erro:', error); alert('Erro ao conectar com o servidor'); });
}

function baixarPDF(tipo, artefatoId) {
    window.open('/api/' + tipo + '/' + artefatoId + '/pdf', '_blank');
}

function publicarPortariaSEI(projetoId) {
    if (!confirm('Deseja publicar a Portaria de Designa√ß√£o no SEI?')) return;
    
    fetch('/api/portaria-designacao/' + projetoId + '/publicar-sei', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
    })
        .then(function (response) {
            if (response.ok) {
                response.json().then(function (data) {
                    alert('Portaria publicada com sucesso! Protocolo SEI: ' + data.protocolo);
                    window.location.reload();
                });
            } else {
                response.json().then(function (data) {
                    alert('Erro ao publicar: ' + (data.detail || 'Erro desconhecido'));
                });
            }
        })
        .catch(function (error) {
            console.error('Erro:', error);
            alert('Erro ao conectar com o servidor');
        });
}
</script>
{% endblock %}
